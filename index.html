<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GPS Tracker + ‡πÄ‡∏™‡∏≤‡πÑ‡∏ü (‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body { height: 100%; margin: 0; padding: 0;
      font-family: "Segoe UI", Tahoma, sans-serif; background: #f5f6fa; }
    #map { height: 100vh; width: 100%; z-index: 1; }

    /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏π‡∏°‡∏Ç‡∏≠‡∏á Leaflet ‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ö‡∏ô */
    .leaflet-top.leaflet-left { top: 70px !important; }
    @media (max-width: 640px){
      .leaflet-top.leaflet-left { top: 120px !important; }
    }

    .status-bar {
      position: fixed; bottom: 10px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 14px; border-radius: 10px;
      font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 1000; line-height: 1.4; max-width: 90%;
    }

    .user-input {
      position: fixed; bottom: 65px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 2000; display: flex; align-items: center; gap: 8px;
    }
    .user-input input {
      border: 1px solid #ccc; border-radius: 6px;
      padding: 5px 8px; font-size: 14px; width: 150px;
    }

    .refresh-btn {
      position: fixed; top: 15px; right: 15px;
      background: #007bff; color: white; border: none;
      padding: 10px 14px; border-radius: 8px;
      font-size: 14px; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.2s ease; z-index: 2000;
    }

    .track-btn {
      background: #28a745; color: white; border: none;
      padding: 10px 14px; border-radius: 8px;
      font-size: 14px; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.2s ease;
    }
    .track-btn.stop { background: #dc3545; }

    .dashboard-btn{
      background:#0ea5e9; color:#fff; border:none;
      padding:10px 14px; border-radius:8px;
      font-size:14px; font-weight:bold; cursor:pointer;
      box-shadow:0 2px 5px rgba(0,0,0,.3);
      text-decoration:none; display:inline-flex; align-items:center; gap:6px;
    }
    .dashboard-btn:hover{ filter: brightness(1.05); }

    .legend {
      position: fixed; bottom: 20px; right: 20px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 8px;
      font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      line-height: 1.6; z-index: 9999;
    }
    .legend div { display: flex; align-items: center; gap: 6px; }
    .legend-color { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #666; }

    .toast {
      position: fixed; top: 20px; right: 20px;
      background: #333; color: white;
      padding: 12px 20px; border-radius: 6px;
      font-size: 14px; opacity: 0;
      transition: opacity 0.5s, transform 0.3s;
      z-index: 3000; transform: translateY(-20px);
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    .btn-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .btn { border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 13px; }
    .btn-green { background: #28a745; color: #fff; }
    .btn-red   { background: #dc3545; color: #fff; }

    .leaflet-div-icon { background: transparent !important; border: none !important; box-shadow: none !important; }

    /* ===== ‡∏à‡∏±‡∏î‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Grid: ‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢ + ‡πÅ‡∏ñ‡∏ö‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡∏ß‡∏≤ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å 2 ‡πÅ‡∏ñ‡∏ß) ===== */
    .top-controls{
      position: fixed; top: 12px; left: 12px; right: 12px;
      display: grid;
      grid-template-columns: auto 1fr;
      grid-template-areas: "actions filter";
      align-items: start;
      gap: 10px;
      z-index: 2000;
    }
    .top-actions{
      grid-area: actions;
      display: flex; gap: 8px; flex-wrap: nowrap;
    }
    .top-controls .track-btn,
    .top-controls .dashboard-btn{
      position: static !important; left: auto !important; top: auto !important;
    }
    .top-controls .filter-bar{
      grid-area: filter;
      position: static !important;
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.95);
      padding: 8px 10px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      flex-wrap: nowrap; white-space: nowrap; overflow-x: auto; width: 100%;
    }
    .filter-bar input {
      border: 1px solid #ccc; border-radius: 6px;
      padding: 6px 8px; font-size: 13px; width: 140px; flex: 0 0 auto;
    }
    .chip {
      border: 1px solid #ccc; background: #fff;
      padding: 6px 10px; border-radius: 999px; font-size: 13px; cursor: pointer;
      user-select: none; flex: 0 0 auto;
    }
    .chip.active { background: #111; color: #fff; border-color: #111; }

    @media (max-width: 640px){
      .top-controls{
        grid-template-columns: 1fr;
        grid-template-areas:
          "actions"
          "filter";
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à -->
  <div class="user-input">
    <label for="username">üë§ ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à:</label>
    <input type="text" id="username" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à" />
  </div>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô: ‡∏õ‡∏∏‡πà‡∏° + ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
  <div class="top-controls">
    <div class="top-actions">
      <button id="trackBtn" class="track-btn">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</button>
      <a class="dashboard-btn"
         href="https://ksupanut16-exat.github.io/lightpole-tracker/dashboard.html"
         target="_blank" rel="noopener">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
    </div>

    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏≤‚Ä¶" />
      <button class="chip active" data-type="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="chip" data-type="POLE">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏™‡∏≤‡πÑ‡∏ü</button>
      <button class="chip" data-type="SP">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ SP</button>
      <button class="chip" data-type="HM">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HM</button>
      <button class="chip" data-type="ON">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î</button>
      <button class="chip" data-type="OFF">‡πÑ‡∏ü‡∏î‡∏±‡∏ö</button>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä -->
  <button id="refreshBtn" class="refresh-btn">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>

  <div id="map"></div>
  <div id="status" class="status-bar">üïì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>

  <div class="legend">
    <b>üó∫Ô∏è ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ:</b>
    <div><span class="legend-color" style="background: #ff66b2;"></span> SP</div>
    <div><span class="legend-color" style="background: #ffd54f;"></span> HM</div>
    <div><span class="legend-color" style="background: green;"></span> ‡πÑ‡∏ü‡∏ï‡∏¥‡∏î (A/B/AB)</div>
    <div><span class="legend-color" style="background: red;"></span> ‡πÑ‡∏ü‡∏î‡∏±‡∏ö (A/B/AB)</div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ===== CONFIG ===== */
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzgw0Qs5-MvsolZD4ncD4tzixdVQ4kYHraDIZQOgs_V5cqMYgQ647-2RmFoxBj4NV160g/exec"; // Apps Script Web App URL
    const PROXY = "https://corsproxy.io/?";
    const SHEET_ID = "1lOm7yLsXgSEod9A2l0YCerJdiHI2lD0m5JMPqYqmupY";
    const SHEET_URL =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

    /* ===== TUNING ===== */
    const MIN_STEP_M = 2;               // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö >= 2 ‡∏°.
    const NEAR_CHECK_MS = 3000;         // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥
    const ACCURACY_TRIGGER_MAX_M = 30;  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏°. ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const ZOOM_IN_DIST_M = 5;           // ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏∏‡∏î <= 5 ‡∏°. ‚Üí ‡∏ã‡∏π‡∏° & popup
    const ZOOM_OUT_DIST_M = 10;         // ‡∏´‡πà‡∏≤‡∏á >= 10 ‡∏°. ‚Üí ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡∏π‡∏°
    const PER_PIN_COOLDOWN_MS = 90_000; // ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î
    const GLOBAL_COOLDOWN_MS  = 6_000;  // ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏£‡∏ß‡∏°
    const AUTO_FIT_ON_REFRESH_WHEN_NOT_TRACKING = true;

    /* ===== Helpers: ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤/‡∏ä‡∏∑‡πà‡∏≠/‡πÇ‡∏Ñ‡πâ‡∏î ===== */
    function showToast(msg, type="info") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.style.background = type === "success" ? "#28a745" :
                               type === "error" ? "#dc3545" : "#333";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }
    function toNumber(x) {
      if (typeof x === "number") return x;
      if (typeof x === "string") {
        const cleaned = x.trim().replace(/,/g, ".").replace(/[^\d.\-]/g, "");
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : NaN;
      }
      return NaN;
    }
    function toText(x) { return (x ?? "").toString().trim(); }

    // ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏™‡∏≤ (SP/HM/SO + ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡∏£‡∏¥‡∏á
    function extractCode(str) {
      const s = (str ?? "").toString().trim();
      if (!s) return null;
      const m = s.toUpperCase().match(/\b(SP|HM|SO)\s*[- ]?\s*0*(\d{1,4})\b/);
      return m ? `${m[1]}${m[2]}` : null;
    }
    function deriveName(nameRaw, statusRaw) {
      const nameTxt = (nameRaw ?? "").toString().trim();
      if (nameTxt) return nameTxt;
      const codeFromStatus = extractCode(statusRaw);
      return codeFromStatus || "";
    }
    function getCodePrefix(x){
      const s = (x ?? "").toString().trim().toUpperCase();
      if (!s) return null;
      let m = s.match(/^(SP|HM)\b/);
      if (m) return m[1];
      m = s.match(/\b(SP|HM)\s*[- ]?\s*\d+/);
      return m ? m[1] : null;
    }
    function isSP(x){ return getCodePrefix(x) === "SP"; }
    function isHM(x){ return getCodePrefix(x) === "HM"; }

    // ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏î (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ > ‡∏ä‡∏∑‡πà‡∏≠)
    function colorFor(status, name) {
      const s = toText(status);
      const nm = toText(name);
      if (/^SP/i.test(s) || /^SP/i.test(nm)) return "#ff66b2"; // ‡∏ä‡∏°‡∏û‡∏π
      if (/^HM/i.test(s) || /^HM/i.test(nm)) return "#ffd54f"; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
      if (/‡πÑ‡∏ü‡∏î‡∏±‡∏ö/i.test(s)) return "red";
      if (/‡πÑ‡∏ü‡∏ï‡∏¥‡∏î/i.test(s)) return "green";
      return "blue";
    }
    function circleIcon(color) {
      return L.divIcon({
        html: `<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid white;"></div>`,
        className: ""
      });
    }

    function sendStatusToSheet(name, newStatus) {
      const fullURL = PROXY + encodeURIComponent(WEBHOOK_URL);
      const user = (document.getElementById("username").value || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à").trim();
      fetch(fullURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, status: newStatus, user })
      })
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json().catch(()=> ({}));
      })
      .then(() => showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${newStatus}" ‡πÅ‡∏•‡πâ‡∏ß (${name})`, "success"))
      .catch(e => { console.error(e); showToast("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!", "error"); });
    }

    function createPopup(marker, name, status, color) {
      const ding = document.getElementById("ding");
      const div = document.createElement("div");
      div.innerHTML = `
        <b>${name}</b><br>
        üî∞ <b id="statusText" style="color:${color}">${status || "-"}</b><br><br>
        <div class="btn-row">
          <button class="btn btn-green" id="onA">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î A</button>
          <button class="btn btn-green" id="onB">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î B</button>
          <button class="btn btn-green" id="onAB">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î AB</button>
          <button class="btn btn-red"   id="offA">‡πÑ‡∏ü‡∏î‡∏±‡∏ö A</button>
          <button class="btn btn-red"   id="offB">‡πÑ‡∏ü‡∏î‡∏±‡∏ö B</button>
          <button class="btn btn-red"   id="offAB">‡πÑ‡∏ü‡∏î‡∏±‡∏ö AB</button>
        </div>
      `;
      const popup = L.popup().setContent(div);
      marker.bindPopup(popup);

      marker.on("popupopen", () => {
        const statusTextEl = div.querySelector("#statusText");
        function updateStatus(newStatus) {
          const newColor = colorFor(newStatus, name);
          statusTextEl.style.color = newColor;
          statusTextEl.textContent = newStatus;
          marker.setIcon(circleIcon(newColor));
          marker.options.status = newStatus;  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏ï‡∏±‡∏ß marker (‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏á)
          ding.currentTime = 0; ding.play();
          marker.closePopup();
          sendStatusToSheet(name, newStatus);
          applyFilters(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ú‡∏•‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        }
        div.querySelector("#onA").onclick  = () => updateStatus("‡πÑ‡∏ü‡∏ï‡∏¥‡∏îA");
        div.querySelector("#onB").onclick  = () => updateStatus("‡πÑ‡∏ü‡∏ï‡∏¥‡∏îB");
        div.querySelector("#onAB").onclick = () => updateStatus("‡πÑ‡∏ü‡∏ï‡∏¥‡∏îAB");
        div.querySelector("#offA").onclick = () => updateStatus("‡πÑ‡∏ü‡∏î‡∏±‡∏öA");
        div.querySelector("#offB").onclick = () => updateStatus("‡πÑ‡∏ü‡∏î‡∏±‡∏öB");
        div.querySelector("#offAB").onclick= () => updateStatus("‡πÑ‡∏ü‡∏î‡∏±‡∏öAB");
      });
    }

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
    let map, markers = [], markerByName = new Map();
    let userMarker = null, userCircle = null;
    let userPath = [], userPolyline = null;
    let watchID = null, isZoomedIn = false, firstDataLoaded = false;

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö throttling & cooldown
    let lastNearCheckAt = 0;
    let lastGlobalNotifyAt = 0;
    const perPinNotifiedAt = new Map(); // name -> timestamp

    // ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
    let activeTypeFilter = "ALL"; // ALL | POLE | SP | HM | ON | OFF
    let searchQuery = "";

    // ‡∏≠‡∏¥‡∏•‡∏¥‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
    let statusEl, trackBtn, refreshBtn, searchInput, chipButtons;

    async function loadSheetData() {
      try {
        const res = await fetch(SHEET_URL, { cache: "no-store" });
        const text = await res.text();

        // ‡∏•‡πâ‡∏≤‡∏á markers ‡πÄ‡∏Å‡πà‡∏≤
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        markerByName.clear();

        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;

        rows.forEach((r, i) => {
          // ‡∏õ‡∏£‡∏±‡∏ö index ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
          const rawName   = r.c[0]?.v ?? r.c[0]?.f;   // Name
          const rawLat    = r.c[1]?.v ?? r.c[1]?.f;   // Latitude
          const rawLng    = r.c[2]?.v ?? r.c[2]?.f;   // Longitude
          const rawStatus = r.c[8]?.v ?? r.c[8]?.f;   // Status

          const latNum = toNumber(rawLat);
          const lngNum = toNumber(rawLng);
          if (!Number.isFinite(latNum) || !Number.isFinite(lngNum)) return;

          const name   = deriveName(rawName, rawStatus);
          const status = toText(rawStatus);
          const color = colorFor(status, name);

          const m = L.marker([latNum, lngNum], {
            icon: circleIcon(color),
            name,
            status
          }).addTo(map);

          createPopup(m, name, status, color);
          markers.push(m);
          markerByName.set(name || `row_${i}`, m);
        });

        if (markers.length && (!firstDataLoaded ||
            (AUTO_FIT_ON_REFRESH_WHEN_NOT_TRACKING && !watchID))) {
          map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2));
          firstDataLoaded = true;
        }

        statusEl.innerHTML = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString();
        applyFilters(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      } catch (e) {
        console.error(e);
        statusEl.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      }
    }

    function startTracking() {
      if (watchID) return;
      showToast("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...", "success");
      trackBtn.textContent = "‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°";
      trackBtn.classList.add("stop");

      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(() => {});
      }

      watchID = navigator.geolocation.watchPosition(onPosition, onPositionError, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      });
    }
    function stopTracking() {
      if (!watchID) return;
      navigator.geolocation.clearWatch(watchID);
      watchID = null;
      trackBtn.textContent = "‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°";
      trackBtn.classList.remove("stop");
      showToast("üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß", "info");

      if (document.fullscreenElement) {
        document.exitFullscreen().catch(() => {});
      }
    }

    function onPosition(pos) {
      const { latitude, longitude, accuracy } = pos.coords;
      const now = Date.now();

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      if (userMarker) map.removeLayer(userMarker);
      if (userCircle) map.removeLayer(userCircle);
      userMarker = L.marker([latitude, longitude], { icon: L.divIcon({ html: "üìç" }) }).addTo(map);
      userCircle = L.circle([latitude, longitude], { radius: accuracy }).addTo(map);

      // ‡∏ï‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏•‡∏î‡∏à‡∏∏‡∏î‡πÅ‡∏ô‡πà‡∏ô
      const newLatLng = L.latLng(latitude, longitude);
      let addedPoint = false;
      if (userPath.length === 0) { userPath.push(newLatLng); addedPoint = true; }
      else {
        const last = userPath[userPath.length - 1];
        const moved = map.distance(last, newLatLng);
        if (moved >= MIN_STEP_M) { userPath.push(newLatLng); addedPoint = true; }
      }
      if (userPolyline) { if (addedPoint) userPolyline.addLatLng(newLatLng); }
      else { userPolyline = L.polyline(userPath, { color: "#007bff", weight: 4 }).addTo(map); }

      // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      map.setView([latitude, longitude], Math.max(map.getZoom(), 17));

      // ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
      statusEl.innerHTML =
        `üìç ${latitude.toFixed(5)}, ${longitude.toFixed(5)} (¬±${accuracy.toFixed(1)} m)`;

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏ö‡∏ö throttle
      if (now - lastNearCheckAt >= NEAR_CHECK_MS) {
        lastNearCheckAt = now;
        checkNearbyMarkers(newLatLng, accuracy, now);
      }
    }
    function onPositionError() {
      showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ!", "error");
    }

    function checkNearbyMarkers(latlng, accuracy, nowTs) {
      if (accuracy > ACCURACY_TRIGGER_MAX_M) return;

      let nearest = null, nearestDist = Infinity;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á)
      for (const m of markers) {
        if (!map.hasLayer(m)) continue;
        const d = map.distance(latlng, m.getLatLng());
        if (d < nearestDist) { nearest = m; nearestDist = d; }
      }
      if (!nearest) return;

      const name = nearest.options.name || "(‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠)";
      const lastPerPin = perPinNotifiedAt.get(name) || 0;
      const globalOk = (nowTs - lastGlobalNotifyAt) >= GLOBAL_COOLDOWN_MS;
      const perPinOk  = (nowTs - lastPerPin)        >= PER_PIN_COOLDOWN_MS;

      if (nearestDist <= ZOOM_IN_DIST_M && globalOk && perPinOk && !isZoomedIn) {
        isZoomedIn = true;
        perPinNotifiedAt.set(name, nowTs);
        lastGlobalNotifyAt = nowTs;

        map.setView(nearest.getLatLng(), 19, { animate: true });
        nearest.openPopup();
        document.getElementById("ding").play();
        showToast(`üì° ‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î ${name} ‡∏£‡∏∞‡∏¢‡∏∞ ${nearestDist.toFixed(1)} ‡∏°.`, "info");
      }
      if (nearestDist >= ZOOM_OUT_DIST_M && isZoomedIn) {
        isZoomedIn = false;
      }
    }

    /* ===== ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå ===== */
    function markerPassTypeFilter(m) {
      const name = (m.options.name || "");
      const st   = (m.options.status || "");

      switch (activeTypeFilter) {
        case "SP":   return isSP(name) || isSP(st);
        case "HM":   return isHM(name) || isHM(st);
        case "ON":   return /‡πÑ‡∏ü‡∏ï‡∏¥‡∏î/i.test(st);
        case "OFF":  return /‡πÑ‡∏ü‡∏î‡∏±‡∏ö/i.test(st);
        case "POLE": // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‚Äù = ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà SP/HM
          return !(isSP(name) || isHM(name) || isSP(st) || isHM(st));
        default:     return true; // ALL
      }
    }
    function markerPassSearch(m) {
      if (!searchQuery) return true;
      const name = (m.options.name || "").toLowerCase();
      return name.includes(searchQuery);
    }
    function applyFilters() {
      searchQuery = (searchInput?.value || "").trim().toLowerCase();
      markers.forEach(m => {
        const shouldShow = markerPassTypeFilter(m) && markerPassSearch(m);
        if (shouldShow) { if (!map.hasLayer(m)) m.addTo(map); }
        else { if (map.hasLayer(m)) map.removeLayer(m); }
      });
    }

    /* ===== ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ===== */
    window.onload = () => {
      map = L.map('map').setView([13.736717, 100.523186], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { maxZoom: 19 }).addTo(map);

      statusEl   = document.getElementById("status");
      trackBtn   = document.getElementById("trackBtn");
      refreshBtn = document.getElementById("refreshBtn");
      searchInput = document.getElementById("searchInput");
      chipButtons = Array.from(document.querySelectorAll(".chip"));

      trackBtn.onclick = () => { if (watchID) stopTracking(); else startTracking(); };
      refreshBtn.onclick = loadSheetData;

      chipButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          activeTypeFilter = btn.dataset.type;
          chipButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          applyFilters();
        });
      });
      searchInput?.addEventListener("input", applyFilters);

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
      loadSheetData();
      setInterval(loadSheetData, 300000);

      // ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÅ‡∏ö‡∏ï/‡πÄ‡∏ô‡πá‡∏ï: ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && watchID) stopTracking();
      });
    };
  </script>
</body>
</html>
