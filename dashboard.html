<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Lightpole Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#0ea5e9; --ok:#10b981; --warn:#ef4444;
    }
    *{ box-sizing: border-box; }
    html,body{ margin:0; background:#0b1220; color:#e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    a{ color:#93c5fd; text-decoration:none; }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; position:sticky; top:0; background:rgba(11,18,32,.85); backdrop-filter: blur(8px); z-index:5;
      border-bottom:1px solid rgba(148,163,184,.15);
    }
    .brand{ font-weight:700; letter-spacing:.2px; }
    .subtle{ color:var(--muted); font-size:13px; }
    .container{ max-width:1100px; margin:14px auto; padding:0 12px 40px; }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:10px 0 16px;
      background: rgba(255,255,255,.04); padding:10px; border-radius:12px; border:1px solid rgba(148,163,184,.12);
    }
    .toolbar input{
      background:#0b1220; color:#e5e7eb; border:1px solid rgba(148,163,184,.25);
      padding:8px 10px; border-radius:8px; font-size:14px;
    }
    .toolbar button{
      background: var(--accent); color:white; border:0; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer;
    }

    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr 1fr; } }

    .cards{ display:grid; gap:12px; grid-template-columns: repeat(2, 1fr); margin:12px 0; }
    @media (min-width: 700px){ .cards{ grid-template-columns: repeat(4, 1fr);} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(148,163,184,.12); border-radius:14px;
      padding:12px; min-height:84px;
    }
    .card .k{ font-size:12px; color:var(--muted); }
    .card .v{ font-size:22px; font-weight:800; margin-top:6px; }
    .ok{ color: var(--ok); } .warn{ color: var(--warn); }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(148,163,184,.12); border-radius:14px; padding:12px;
    }
    .panel h3{ margin:0 0 8px; font-size:16px; }
    .muted{ color: var(--muted); }

    canvas{ width:100% !important; height:320px !important; }

    table{ width:100%; border-collapse: collapse; font-size:13px; }
    th, td{ padding:8px 10px; border-bottom:1px solid rgba(148,163,184,.12); }
    th{ text-align:left; color:var(--muted); font-weight:600; font-size:12px; }
    tbody tr:hover{ background: rgba(255,255,255,.03); }
    .badge{ display:inline-block; border:1px solid rgba(148,163,184,.25); border-radius:999px; padding:2px 8px; font-size:12px; }
    .badge.ok{ border-color: rgba(16,185,129,.3); color:#a7f3d0; }
    .badge.warn{ border-color: rgba(239,68,68,.35); color:#fecaca; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow{ flex: 1; }
    .right{ text-align:right; }

    .toast{
      position: fixed; bottom: 16px; right: 16px; background: #111827; color:#fff;
      border:1px solid rgba(148,163,184,.2); border-radius:10px; padding:10px 12px; font-size:14px;
      opacity:0; transform: translateY(10px); transition: all .25s ease; z-index:10;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">Lightpole Dashboard</div>
      <div class="subtle">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏ü‡∏ï‡∏¥‡∏î-‡πÑ‡∏ü‡∏î‡∏±‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</div>
    </div>
    <div class="subtle"><a href="./">üîô ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a></div>
  </header>

  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="row grow">
        <div>
          ‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:
          <input type="date" id="fromDate">
          <input type="date" id="toDate">
          <button id="applyRange">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</button>
        </div>
      </div>
      <div class="subtle">* ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö ‚Äú‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏ü‡∏î‡∏±‡∏ö/‡∏ß‡∏±‡∏ô‚Äù ‡πÅ‡∏•‡∏∞ ‚ÄúTop ‡πÄ‡∏™‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏±‡∏ö‡∏ö‡πà‡∏≠‡∏¢‚Äù</div>
    </div>

    <!-- Summary cards -->
    <div class="cards" id="cards">
      <div class="card"><div class="k">‡πÄ‡∏™‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="v" id="totalPoles">-</div></div>
      <div class="card"><div class="k">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div><div class="v ok" id="onCount">-</div></div>
      <div class="card"><div class="k">‡πÑ‡∏ü‡∏î‡∏±‡∏ö (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div><div class="v warn" id="offCount">-</div></div>
      <div class="card"><div class="k">‡∏ä‡∏ô‡∏¥‡∏î: SP / HM / ‡∏≠‡∏∑‡πà‡∏ô</div><div class="v" id="typeCounts">-</div></div>
    </div>

    <div class="grid">
      <!-- Left column -->
      <div class="panel">
        <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‚Äú‡πÑ‡∏ü‡∏î‡∏±‡∏ö‚Äù ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
        <div class="subtle">‡∏à‡∏≤‡∏Å Log ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
        <canvas id="dailyOffChart"></canvas>
      </div>

      <!-- Right column -->
      <div class="panel">
        <h3>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
        <div class="subtle">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
        <canvas id="currentPie"></canvas>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="row">
        <h3 class="grow">Top 10 ‡πÄ‡∏™‡∏≤‡∏ó‡∏µ‡πà ‚Äú‡πÑ‡∏ü‡∏î‡∏±‡∏ö‚Äù ‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
        <div class="muted">‡∏î‡∏π‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô entry ‚Äú‡πÑ‡∏ü‡∏î‡∏±‡∏ö‚Äù ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Logs</div>
      </div>
      <canvas id="topOffBar"></canvas>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="row">
        <h3 class="grow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div class="muted">50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö Logs</div>
      </div>
      <div style="overflow:auto">
        <table id="logTable">
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏≤</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</th>
              <th>‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ============ CONFIG ============ */
    const SHEET_ID = "1lOm7yLsXgSEod9A2l0YCerJdiHI2lD0m5JMPqYqmupY";       // <-- 1lOm7yLsXgSEod9A2l0YCerJdiHI2lD0m5JMPqYqmupY ‡πÉ‡∏™‡πà SHEET ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const MAIN_SHEET_NAME = "sheets1";                // <-- ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
    const LOG_SHEET_NAME  = "Logs";                  // <-- ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö Logs

    const MAIN_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(MAIN_SHEET_NAME)}`;
    const LOG_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(LOG_SHEET_NAME)}`;

    /* ============ Utilities ============ */
    const $ = sel => document.querySelector(sel);
    function showToast(msg){
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2400);
    }
    function parseGViz(text){
      const start = text.indexOf('{'); const end = text.lastIndexOf('}');
      return JSON.parse(text.slice(start, end+1));
    }
    function colIndexByLabels(cols, labels){
      const lows = labels.map(s=>s.toLowerCase());
      return cols.findIndex(c => lows.includes(String(c.label||'').trim().toLowerCase()));
    }
    function cell(row, idx){ return row?.c?.[idx]?.v ?? row?.c?.[idx]?.f ?? ""; }

    // Parse Date from GViz (support Date(YYYY,MM,DD,hh,mm,ss) or string)
    function parseGVizDate(v){
      if (!v) return null;
      if (typeof v === 'string'){
        const m = v.match(/Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)/);
        if (m){
          const [_, Y,M,D,h=0,mn=0,s=0] = m.map(Number);
          return new Date(Y, M, D, h, mn, s);
        }
        // plain string to Date
        const d = new Date(v);
        return isNaN(d) ? null : d;
      }
      if (typeof v === 'object' && v !== null && 'f' in v) {
        const d = new Date(v.f); return isNaN(d) ? null : d;
      }
      return v instanceof Date ? v : null;
    }

    function isOn(status){ return /‡πÑ‡∏ü‡∏ï‡∏¥‡∏î/i.test(String(status)); }
    function isOff(status){ return /‡πÑ‡∏ü‡∏î‡∏±‡∏ö/i.test(String(status)); }
    function typeOfPole(name, status){
      const s = String(status||''); const n = String(name||'');
      if (/^SP/i.test(n) || /^SP/i.test(s)) return 'SP';
      if (/^HM/i.test(n) || /^HM/i.test(s)) return 'HM';
      return 'OTHER';
    }
    function fmtDate(d){
      return d ? d.toLocaleString('th-TH', { dateStyle:'medium', timeStyle:'short' }) : '-';
    }
    function fmtDay(d){
      return d ? d.toLocaleDateString('th-TH', { dateStyle:'medium' }) : '-';
    }

    /* ============ Charts refs ============ */
    let dailyOffChart, currentPieChart, topOffBarChart;

    function makeLine(ctx, labels, data){
      return new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'‡πÑ‡∏ü‡∏î‡∏±‡∏ö/‡∏ß‡∏±‡∏ô', data, tension:.3 }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }
    function makePie(ctx, on, off, unk){
      return new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['‡πÑ‡∏ü‡∏ï‡∏¥‡∏î','‡πÑ‡∏ü‡∏î‡∏±‡∏ö','‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'], datasets:[{ data:[on,off,unk] }] },
        options:{ plugins:{ legend:{ position:'bottom' } } }
      });
    }
    function makeBar(ctx, labels, data){
      return new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏î‡∏±‡∏ö', data }] },
        options:{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }

    /* ============ Loaders ============ */
    async function fetchGViz(url){
      const r = await fetch(url, { cache:'no-store' });
      const t = await r.text();
      return parseGViz(t);
    }

    function setDefaultRange(){
      const to = new Date();
      const from = new Date(); from.setDate(to.getDate() - 30);
      $('#fromDate').value = from.toISOString().slice(0,10);
      $('#toDate').value   = to.toISOString().slice(0,10);
    }

    function getRange(){
      const f = $('#fromDate').value, t = $('#toDate').value;
      const from = f ? new Date(`${f}T00:00:00`) : null;
      const to   = t ? new Date(`${t}T23:59:59`) : null;
      return { from, to };
    }
    function inRange(d, from, to){
      if (!d) return false;
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    async function loadAll(){
      try{
        showToast('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶');
        const [main, logs] = await Promise.all([fetchGViz(MAIN_URL), fetchGViz(LOG_URL)]);

        // ===== Main sheet summary =====
        const mcols = main.table.cols;
        const mrows = main.table.rows;
        const idx = {
          name:   colIndexByLabels(mcols, ['name','‡∏ä‡∏∑‡πà‡∏≠','‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏≤']),
          lat:    colIndexByLabels(mcols, ['latitude','lat','‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î']),
          lng:    colIndexByLabels(mcols, ['longitude','lng','‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î']),
          status: colIndexByLabels(mcols, ['status','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'])
        };
        const items = [];
        for (const r of mrows){
          const name = cell(r, idx.name);
          const status = cell(r, idx.status);
          const lat = cell(r, idx.lat), lng = cell(r, idx.lng);
          if (!lat || !lng) continue;
          items.push({ name, status });
        }

        const totalAll = items.length;
const sp  = items.filter(x => typeOfPole(x.name,x.status) === 'SP').length;
const hm  = items.filter(x => typeOfPole(x.name,x.status) === 'HM').length;
const other = totalAll - sp - hm; // = ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏ö SP ‡∏•‡∏ö HM

// ‚úÖ ‡πÄ‡∏™‡∏≤‡πÑ‡∏ü (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° SP/HM)
$('#totalPoles').textContent = other.toLocaleString();

// ‡∏Ñ‡∏á on/off ‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏±‡∏á‡∏ô‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) ‡∏ï‡∏≤‡∏°‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏î‡∏¥‡∏°
const onCountAll  = items.filter(x=>isOn(x.status)).length;
const offCountAll = items.filter(x=>isOff(x.status)).length;
const unkCountAll = totalAll - onCountAll - offCountAll;

$('#onCount').textContent  = onCountAll.toLocaleString();
$('#offCount').textContent = offCountAll.toLocaleString();
$('#typeCounts').textContent = `${sp} / ${hm} / ${other}`;

// pie ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ pie ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° SP/HM‚Äù ‡∏î‡∏π‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
if (currentPieChart) currentPieChart.destroy();
currentPieChart = makePie($('#currentPie'), onCountAll, offCountAll, unkCountAll);


        // ===== Logs analytics =====
        const lcols = logs.table.cols;
        const lrows = logs.table.rows;
        const L = {
          time:      colIndexByLabels(lcols, ['‡πÄ‡∏ß‡∏•‡∏≤','time','timestamp']),
          name:      colIndexByLabels(lcols, ['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏≤','name']),
          oldStatus: colIndexByLabels(lcols, ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°','old','oldstatus']),
          newStatus: colIndexByLabels(lcols, ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà','new','newstatus']),
          editor:    colIndexByLabels(lcols, ['‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç','‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î','editor','user'])
        };

        // table last 50
        const tbody = $('#logTable tbody');
        tbody.innerHTML = '';
        const latest = [...lrows].slice(-50).reverse();
        for (const r of latest){
          const d = parseGVizDate(cell(r, L.time));
          const name = cell(r, L.name);
          const oldS = cell(r, L.oldStatus);
          const newS = cell(r, L.newStatus);
          const editor = cell(r, L.editor);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(d)}</td>
            <td>${name || '-'}</td>
            <td><span class="badge ${isOff(oldS)?'warn':isOn(oldS)?'ok':''}">${oldS||'-'}</span></td>
            <td><span class="badge ${isOff(newS)?'warn':isOn(newS)?'ok':''}">${newS||'-'}</span></td>
            <td>${editor || '-'}</td>
          `;
          tbody.appendChild(tr);
        }

        // analytics by selected range
        const { from, to } = getRange();

        // per-day OFF counts
        const dayMap = new Map(); // key: yyyy-mm-dd, val: count
        // top poles OFF counts
        const offByPole = new Map();

        for (const r of lrows){
          const d   = parseGVizDate(cell(r, L.time));
          const nm  = String(cell(r, L.name) || '');
          const nst = String(cell(r, L.newStatus) || '');
          if (!inRange(d, from, to)) continue;

          if (isOff(nst)){
            const key = d.toISOString().slice(0,10);
            dayMap.set(key, (dayMap.get(key)||0)+1);
            offByPole.set(nm, (offByPole.get(nm)||0)+1);
          }
        }

        // build arrays sorted by day
        const keys = Array.from(dayMap.keys()).sort();
        const dailyLabels = keys.map(k=>{
          const [y,m,d] = k.split('-').map(Number);
          return new Date(y, m-1, d);
        });
        const dailyCounts = keys.map(k=> dayMap.get(k));

        if (dailyOffChart) dailyOffChart.destroy();
        dailyOffChart = makeLine($('#dailyOffChart'), dailyLabels.map(fmtDay), dailyCounts);

        // top off poles (desc)
        const top = Array.from(offByPole.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
        const topLabels = top.map(([n])=>n);
        const topCounts = top.map(([_,c])=>c);
        if (topOffBarChart) topOffBarChart.destroy();
        topOffBarChart = makeBar($('#topOffBar'), topLabels, topCounts);

        showToast('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }catch(e){
        console.error(e);
        showToast('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      }
    }

    // Init
    window.addEventListener('load', ()=>{
      setDefaultRange();
      loadAll();
      $('#applyRange').addEventListener('click', loadAll);
    });
  </script>
</body>
</html>
